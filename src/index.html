<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--  引入Bootstrap样式文件  -->
    <link type="text/css" rel="stylesheet" href="./assets//css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="./assets//css/bootstrap-select.min.css" />
    <!--  引入Font Awesome字体样式文件  >
    <link type="text/css" rel="stylesheet" href="./assets/font/font-awesome.min.css" /-->
    <!--meta http-equiv="Access-Control-Allow-Origin" content="*"-->

    <!--引入bootstrap-slider 样式文件-->
    <link href="./assets/css/bootstrap-slider.css" rel="stylesheet" />
    <title>川金丝猴亲缘结构可视化V1</title>
    <style>
        body{margin: 0;overflow: hidden;}
    </style>
    
</head>

<link rel="stylesheet" href="./assets/css/base.css">
<link rel="stylesheet" href="./assets/css/content.css">
<body>
    <script type="text/javascript" src="./assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="./assets/js/popper.min.js"></script>
    <script type="text/javascript" src="./assets/js/bootstrap.min.js"></script>
    <!--script type="text/javascript" src="./assets/js/bootstrap-slider.min.js"></script-->
    <script type="text/javascript" src="./assets/js/bootstrap-slider.js"></script>
    <script type="text/javascript" src="./assets/js/bootstrap-treeview.js"></script>
    <script type="text/javascript" src="./assets/js/bootstrap-select.min.js"></script>
    <!-- 引入读取 .xlxs 格式的文件 -->
    <script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.15.6/xlsx.full.min.js"></script>
    
    <!--script src="https://gw.alipayobjects.com/os/antv/pkg/_antv.g6-3.1.0/build/g6.js"></script-->


   <div class="box">
    <div id="mountNode" style="display: none;"></div>
    <div class="header row">
        <!-- <input type="color" value="#2D9900"/> -->
        <div class="col col-xl-2"  style="display: inline; height: 30px;white-space: nowrap; margin-left: 80px;">
          <!-- <label style="color: white;">选择Monkey</label> -->
          <!-- 如果需要多选，则可以在select 中添加 multiple -->
          <select class="selectpicker" data-live-search="true"   id="monkeySelecter" title="根据ID选择金丝猴" data-style="btn-info" data-none-selected-text="选择Monkey的ID"  data-actions-box="true">
          </select>
        </div>

        <div class="col col-xl-8" id="mode" style="display: inline;height: 30px; white-space: nowrap;margin-left: 20px;">
            <div class="tick-range" style="align-self: center; white-space: nowrap; display: inline; ">
                <!-- <input id="tickRangeToggle" type="checkbox" checked/> Enabled -->
                <label>亲缘关系时间范围：</label>
                <b id="tickLow">0</b>&nbsp;&nbsp;
                <input id="tickRange" type="text" class="span2" style="width: 15%;" value="" data-slider-id="slider" data-slider-min="0" data-slider-max="0" data-slider-step="1" data-slider-value="[0,0]"/>
                &nbsp;&nbsp;<b id="tickHigh">0</b>
            </div>&nbsp;&nbsp;&nbsp;

            <div class="tick-range" style="align-self: center; white-space: nowrap; display: inline;">
              <!-- <input id="tickRangeStrucToggle" type="checkbox" checked/> Enabled -->
              <label>社会组成时间范围：</label>
              <b id="tickLowStruc">0</b>&nbsp;&nbsp;
              <input id="tickRangeStruc" type="text" class="span2" style="width: 15%;" value="" data-slider-id="sliderStruc" data-slider-min="0" data-slider-max="0" data-slider-step="1" data-slider-value="[0,0]"/>
              &nbsp;&nbsp;<b id="tickHighStruc">0</b>
            </div>

            <div id="tickRange"></div>
            <div id="tickRangeStruc"></div>
            
        </div>
        
        <div class="dropdown dropleft col col-xl-1">
          <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            菜单
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
            <button class="btn btn-info" onclick="$('#data').click()" style="text-align: center; width: 95%; margin: 2px 2px 0 2px;">导入金丝猴社群数据</button><br>
            <button class="btn btn-info" onclick="exportCommunityData()" style="text-align: center; width: 95%; margin: 2px 2px 0 2px;">导出社群数据</button><br>
          </div>
        </div>
        

        <!-- 可定制的要素 -->
        <div style="align-self: center; white-space: nowrap; display: inline-block; width: 100%;margin: 0; padding: 0; text-align: center;">
          <div id="customKeyDiv" style="width: 100%; margin: 0; padding: 0; text-align: center;">
            <a class="collapsed btn btn-link glyphicon glyphicon-chevron-down" type="button"  style="color: white; font-weight: bolder; font-size: 15px; padding-top: 0;"
            data-toggle="collapse" data-target="#customKeyCollapse" aria-expanded="false" aria-controls="customKeyCollapse">
              定制显示要素
            </a>
          </div>
          <div id="customKeyCollapse" class="collapse" aria-labelledby="customKeyDiv" data-parent="#customKeyDiv"
           style="background-color: #fbfbfbc9 ; border-radius: 5px; margin: 5px 30%; padding: 0; position: relative; z-index: 10000; text-align: left;">

          </div>
        </div>

    </div>
    <div class="main">
        <div class="left">left</div>
        <div class="center">
        </div>

        <div class="right" style="display: flex;">
            <div style="flex: 1; width: auto;">
              <div class="accordion" id="accordionExample"  >
                <div class="card">
                  <div class="card-header" id="headingOne">
                      <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        被选中的金丝猴的信息
                      </button>
                  </div>
                  <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#headingOne">
                    <div class="card-body" style="white-space:normal; word-break:break-all;overflow:hidden;">
                        <ul class="list-group" id="monkey_info" style="white-space: normal; font-family:Consolas; ">
                            <li class="list-group-item list-group-item-success" value="ID">ID: </li>
                            <li class="list-group-item list-group-item-success" value="NAME">NAME: </li>
                            <li class="list-group-item list-group-item-success" value="GENDA">GENDA: </li>
                            <li class="list-group-item list-group-item-success" value="GENDA">入群时间: </li>
                            <li class="list-group-item list-group-item-success" value="年龄段">年龄段: </li>
                            <li class="list-group-item list-group-item-success" value="分身所属单元">分身所属单元: </li>
                            <li class="list-group-item list-group-item-success" value="当前所属单元">当前所属单元: </li>
                            <li class="list-group-item list-group-item-success" value="孩子" data-toggle="tooltip" data-placement="top" title="孩子的ID">孩子: </li>
                            <li class="list-group-item list-group-item-success" value="母亲" data-toggle="tooltip" data-placement="top" title="母亲的名字及ID">母亲: </li>
                            <li class="list-group-item list-group-item-success" value="父亲" data-toggle="tooltip" data-placement="top" title="父亲的名字及ID">父亲: </li>
                            <li class="list-group-item list-group-item-success" value="isAlive" data-toggle="tooltip" data-placement="top" title="是否存活">isAlive: </li>
                            <li class="list-group-item list-group-item-success" value="inCommu" data-toggle="tooltip" data-placement="top" title="是否在社群中">inCommu: </li>
                            <li class="list-group-item list-group-item-success" value="isMirror" data-toggle="tooltip" data-placement="top" title="是否是分身">isMirror: </li>
                            <button type="button" class="btn btn-danger" id="saveLog"  style="width: 40%; align-self: center;margin: .5em 0 0 .5em; font-size: medium; display: none;" data-toggle="tooltip" data-placement="top" title="保存日志">save log</button>
                        </ul>
                        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#monkeyLifeInfo" aria-expanded="false" aria-controls="monkeyLifeInfo"
                        style="width: 90%; margin: 3px 0 1.5px 5%; display: inline;">显示生平信息</button>
                        <div class="collapse" id="monkeyLifeInfo">

                        </div>
                        
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header" id="headingTwo" style="white-space:normal; word-break:break-all;overflow:hidden;">
                      <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                        被选中的单元的信息
                      </button>
                  </div>
                  <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#headingTwo">
                    <div class="card-body" style="white-space:normal; word-break:break-all;overflow:hidden;">
                      <ul class="list-group" id="unit_info" style="white-space: normal; font-family:Consolas; ">
                        <li class="list-group-item list-group-item-success" value="ID">ID: </li>
                        <li class="list-group-item list-group-item-success" value="NAME">NAME: </li>
                        <li class="list-group-item list-group-item-success" value="CREATED">创建时间: </li>
                      </ul>
                      <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#unitLifeInfo" aria-expanded="false" aria-controls="unitLifeInfo"
                        style="width: 90%; margin: 3px 0 1.5px 5%; display: inline;">显示历史信息</button>
                        <div class="collapse" id="unitLifeInfo">
                          <ul id="unitTickList" style="white-space: normal; font-family:Consolas; ">

                          </ul>
                        </div>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header" id="headingThree">
                      <button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                        社群信息
                      </button>
                  </div>
                  <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#headingThree">
                    <div class="card-body" style="white-space:normal; word-break:break-all;overflow:hidden;">
                        <ul id="tickList" style="white-space: normal; font-family:Consolas; ">

                        </ul>
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin: 5px;align-items: center; " >
                  <!--button type="button" class="btn btn-danger" id="prev"  style="width: 40%; align-self: center;margin: .5em 0 0 .5em; font-size: medium; display: none;" data-toggle="tooltip" data-placement="top" title="回退一个时间单位的亲缘关系">TICK-BACK</button>
                  <button type="button" class="btn btn-danger" id="saveLog"  style="width: 40%; align-self: center;margin: .5em 0 0 .5em; font-size: medium; display: none;" data-toggle="tooltip" data-placement="top" title="保存日志">save log</button-->
                  
                  <button type="button" class="btn btn-danger" id="next"  style="width: 80%; align-self: center;margin: .5em 0 0 .5em; font-size: medium; display: none;" 
                  data-toggle="tooltip" data-placement="top" title="增加一个时间单位的亲缘关系">生成下一时刻亲缘关系</button> 
                  
                  <input type="file" id="data" title="选择金丝猴社群数据" style="display: none;">
                  <button class="btn btn-info" id='showData' style="margin-top: 5px;">SHOW</button>
              </div>
            </div>
            
            
        </div>
    </div>
    <div class="footer"></div>
</div>
<script src="../tsdist/bundle.js"> </script>
<script>
    $("#stats > div").css({
        top: $("div.header").css("height"),
        margin: "1.5px 0px 0px 1.5px",
    })
    $('#tickRangeStruc').slider({
        formatter: function (value) {
            return  value;
        },
        tooltip_split: true,
        tooltip: "always",
        tooltip_position: "bottom",
    })
    $("#tickRangeToggle").click(function() {
      if(this.checked) {
        $("#tickRange").slider("enable");
      }
      else {
        $("#tickRange").slider("disable");
      }
    });
    $("#tickRangeStrucToggle").click(function() {
      if(this.checked) {
        $("#tickRangeStruc").slider("enable");
      }
      else {
        $("#tickRangeStruc").slider("disable");
      }
    });
    var tree = [
  {
    text: "社会变动要素",
    selectable: false,
    selectedIcon: "",
    nodeKey: "strucKey",
    state: {
          checked: true,
    },
    nodes: [
      {
        text: "入群",
        nodeKey: "enterCommu",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["enterCommu"]
        },
      }, {
        text: "退群",
        nodeKey: "outCommu",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["outCommu"]
        },
      }, {
        text: "迁移",
        nodeKey: "migrate",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["migrate"]
        },
      }, {
        text: "主雄变更",
        nodeKey: "mainMaleChange",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["mainMaleChange"]
        },
      }, {
        text: "新增单元",
        nodeKey: "newUnit",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["newUnit"]
        },
      }, {
        text: "死亡",
        nodeKey: "dead",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["dead"]
        },
      }, {
        text: "其他分身",
        nodeKey: "involvedMirror",
        selectable: false,
        state: {
          checked: window.VIEW_KEYS["strucKey"]["involvedMirror"]
        }
      }
      
    ]
  }, {
    text: "亲缘关系",
    nodeKey:"kinship",
    selectable: false,
    state: {
          checked: window.VIEW_KEYS["kinship"]
    },
  },  {
    text: "未涉及个体",
    nodeKey: "uninvolved",
    selectable: false,
    state: {
          checked: window.VIEW_KEYS["uninvolved"],
    },
  },/* {
    text: "所有分身",
    nodeKey: "allmirror",
    selectable: false,
    state: {
      checked: true,
    }
  },{
    text: "未采样个体",
    nodeKey: "unSampled",
    selectable: false,
    state: {
          checked: window.VIEW_KEYS["unSampled"]
    },
  }*/
];


$('#customKeyCollapse').treeview({
  data: tree,         // data is not optional
  levels: 5,
  backColor: 'green',
  multiSelect: true,
  checkedIcon: "glyphicon glyphicon-check",
  //selectedIcon: "glyphicon glyphicon-check",
  showCheckbox: true,
});

$('#customKeyCollapse').on('nodeChecked',function(event, data){
     console.log(" data:", data);
     let tree = $('#customKeyCollapse');
     // 判断被check的node是否有子节点
     if(!data.nodes) {
        // 判断被被check的node是否有父节点
        if(data.parentId != undefined){
          window.VIEW_KEYS[tree.treeview("getNode", data.parentId).nodeKey][data.nodeKey] = true;
          // 如果某个结点的子节点都被check，则该结点也被check
          let siblings = tree.treeview("getSiblings", data.nodeId).map( e => e.state.checked ? 1: 0).reduce((a, b) =>  a+b);
          if( siblings == tree.treeview("getSiblings", data.nodeId).length ){
            tree.treeview("checkNode", [ data.parentId, {silent: true} ]);
          }
        } else {
          window.VIEW_KEYS[data.nodeKey] = true;
        }
      } else{
        data.nodes.forEach( e => {
          tree.treeview('checkNode', [ e.nodeId, { silent: true } ]);
          window.VIEW_KEYS[data.nodeKey][e.nodeKey] = true;
        })
      }
     
    console.log("显示要素发生变化!", window.VIEW_KEYS)
    let v = $("#tickRangeStruc").slider("getValue");
    
    window.community.showRangeCommunityChange( v[0], v[1] );
    

    //if(data.nodeKey = "kinship" ){
      let v1 = $("#tickRange").slider("getValue");
      window.community.showRangeKinship(v1[0], v1[1] );
      if(!window.VIEW_KEYS['kinship']){
        window.community.maskKinship();
      }
    //}
})

$('#customKeyCollapse').on('nodeUnchecked',function(event, data){
     console.log( " data:", data);
     let tree = $('#customKeyCollapse');
     if(!data.nodes) {
        if(data.parentId != undefined){
            window.VIEW_KEYS[tree.treeview("getNode", data.parentId).nodeKey][data.nodeKey] = false;
            tree.treeview("uncheckNode", [ data.parentId, {silent: true} ]);
        } else {
            window.VIEW_KEYS[data.nodeKey] = false;
        }
        
     } else {
      data.nodes.forEach( e => {
        tree.treeview('uncheckNode', [ e.nodeId, { silent: true } ]);
        window.VIEW_KEYS[data.nodeKey][e.nodeKey] = false;
      })
     }
     
    let v = $("#tickRangeStruc").slider("getValue");
    let v1 = $("#tickRange").slider("getValue");
    window.community.showRangeCommunityChange( v[0], v[1] );
    if(data.nodeKey == "kinship" || !window.VIEW_KEYS['kinship']){
      window.community.maskKinship();
      window.community.showRangeCommunityChange( v[0], v[1] );
    } else {
      window.community.showRangeCommunityChange( v[0], v[1] );
      window.community.showRangeKinship(v1[0], v1[1] );
    }
    
})

$("#hideRightSide").on("click", e => {
  console.log("123",$("#hideRightSide").next().width() );
  $("#hideRightSide").next().width(0);
})


// 将一个sheet转成最终的excel文件的blob对象，然后利用URL.createObjectURL下载
function sheet2blob(sheets, sheetNames) {
  sheetNames = sheetNames || sheets.map((e, idx) => 'sheet'+idx);
	var workbook = {
		SheetNames: sheetNames,
		Sheets: {}
  };
  workbook.SheetNames.forEach( (e, idx) => {
    workbook.Sheets[e] = sheets[idx];
  })
	//workbook.Sheets[sheetName] = sheet;
	// 生成excel的配置项
	var wopts = {
		bookType: 'xlsx', // 要生成的文件类型
		bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
		type: 'binary'
	};
	var wbout = XLSX.write(workbook, wopts);
	var blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
	// 字符串转ArrayBuffer
	function s2ab(s) {
		var buf = new ArrayBuffer(s.length);
		var view = new Uint8Array(buf);
		for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
		return buf;
	}
	return blob;
}

/**
 * 通用的打开下载对话框方法，没有测试过具体兼容性
 * @param url 下载地址，也可以是一个blob对象，必选
 * @param saveName 保存文件名，可选
 */
 function openDownloadDialog(url, saveName){
	if(typeof url == 'object' && url instanceof Blob)
	{
		url = URL.createObjectURL(url); // 创建blob地址
	}
	var aLink = document.createElement('a');
	aLink.href = url;
	aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
	var event;
	if(window.MouseEvent) event = new MouseEvent('click');
	else
	{
		event = document.createEvent('MouseEvents');
		event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
	}
	aLink.dispatchEvent(event);
}

function getMonkeyData(){
   var community = window.community;
   var data = new Array([	'ID',	'genda',	'name',	'ageLevel',	'father',	'mother',	'unit',	'dead' , 'year']);
   for(let i = 0; i <= community.frames.length; i++){
      community.allunits.forEach( e => {
        if(e.tickMembers.get(i)){
          e.tickMembers.get(i).forEach(ee => {
            let monkey = community.findMonkeyByID(ee)[0];
            let row = [ee, monkey.genda, monkey.name, monkey.ageLevel, monkey.father ? monkey.father.ID : '', monkey.mother ? monkey.mother.ID : '', e.ID, '', i]
            data.push(row);
          });
        }
      })
      if(i > 0 ){
        community.frames[i-1].vanished.dead.forEach( e => {
          let m = e.monkey;
          let row = [m.ID, m.genda, m.name, m.ageLevel, m.father ? m.father.ID : '', m.mother ? m.mother.ID : '', m.unit.ID, 'T', i];
          data.push(row);
        })
      }
    
   }
   return data;
}

function getUnitData(){
  var data = new Array(['ID', 'type', 'Rank', 'mainMale','adultFemale','young','juvenile','size','year']);
  community = window.community;
  for(let i = 0; i <= community.frames.length; i++){
    community.allunits.forEach( e => {
      if(e.tickMembers.get(i)){
        let row = [e.ID, e.unitType, '', e.unitType=='OMU' && e.mainMale ? e.mainMale.ID : '', '', '', '', e.tickMembers.get(i).length, i ];
        data.push(row);
      }
    })
  }
  return data;
}

function exportCommunityData(){
  var monkeyData = getMonkeyData();
  var unitData = getUnitData();
  var monkeySheet = XLSX.utils.aoa_to_sheet(monkeyData);
  var unitSheet = XLSX.utils.aoa_to_sheet(unitData);
  openDownloadDialog(sheet2blob([monkeySheet, unitSheet], ['金丝猴数据', '单元数据']), '金丝猴社群数据.xlsx');
}


function importFile(obj){//1.onchange事件绑定方法出发
    //2.如果没有选中文件则取消
    console.log(obj);
    if (!obj.target.files){
        return
    }
    //3.获得选择的文件对象
    var f = obj.target.files[0]
    //4.初始化新的文件读取对象，浏览器自带，不用导入
    var reader = new FileReader();
    //5.绑定FileReader对象读取文件对象时的触发方法
    reader.onload = function(e){
        //7.获取文件二进制数据流
        var data = e.currentTarget.result;
        //8.利用XLSX解析二进制文件为xlsx对象
        var wb = XLSX.read(data,{type:'binary'})
        //9.利用XLSX把wb第一个sheet转换成JSON对象
        //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
        //wb.Sheets[Sheet名]获取第一个Sheet的数据
        console.log("workbook:",wb)
        var j_data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
        wb.SheetNames.forEach( ee => {
          let j_data = XLSX.utils.sheet_to_json(wb.Sheets[ee] );
          console.log(`${ee} : `, j_data);
        })
    }
    //6.使用reader对象以二进制读取文件对象f，
    reader.readAsBinaryString(f)
}

$("#11data").change(function(e){
  importFile(e);
})

</script>

</body>
</html>
